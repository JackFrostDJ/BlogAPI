<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Blog API Frontend</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f4f4f4;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .button-row {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }
        .button-row button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .button-row button:hover {
            background: #0056b3;
        }
        .container {
            max-width: 800px;
            margin: auto;
        }
        .post {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
        }
        .post p {
            overflow-wrap: break-word;
            word-wrap: break-word;
            white-space: normal;
        }
        .post h3 {
            margin: 0;
            color: #444;
        }
        label {
            font-weight: bold;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0 10px 0;
        }
        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            z-index: 10;
            width: 90%;
            max-width: 400px;
            display: none;
        }
        .modal h2 {
            margin-top: 0;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 9;
            display: none;
        }
        .close-btn {
            background: red;
            color: white;
            float: right;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
        }
        .show-more {
            background: #6c757d;
            color: white;
            padding: 5px 10px;
            border: none;
            cursor: pointer;
            margin-top: 5px;
        }
        .show-more:hover {
            background: #5a6268;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Welcome to the Blog</h1>

        <div class="button-row">
            <button onclick="openModal('newPostModal')">New Post</button>
            <button onclick="openModal('generatePostModal')">Generate Post</button>
        </div>

        <div id="posts"></div>
    </div>

    <!-- Overlay -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeModal()"></div>

    <!-- New Post Modal -->
    <div class="modal" id="newPostModal">
        <button class="close-btn" onclick="closeModal()">X</button>
        <h2>Add a Post</h2>
        <label>Title:</label>
        <input type="text" id="title">
        <label>Content:</label>
        <textarea id="content"></textarea>
        <label>Author:</label>
        <input type="text" id="author">
        <button onclick="addPost()">Add Post</button>
    </div>

    <!-- AI Post Modal -->
    <div class="modal" id="generatePostModal">
        <button class="close-btn" onclick="closeModal()">X</button>
        <h2>Generate AI Blog Post</h2>
        <label>Prompt:</label>
        <input type="text" id="prompt">
        <button onclick="generateAI()">Generate Post</button>
    </div>

<script>
const API_BASE = "http://127.0.0.1:8000/api";

// Open/Close Modal Logic
function openModal(id) {
    document.getElementById("modalOverlay").style.display = "block";
    document.getElementById(id).style.display = "block";
}
function closeModal() {
    document.getElementById("modalOverlay").style.display = "none";
    document.querySelectorAll(".modal").forEach(modal => modal.style.display = "none");
}

// Fetch and display posts + comments
async function fetchPosts() {
    const res = await fetch(`${API_BASE}/posts/`);
    const data = await res.json();
    const postsDiv = document.getElementById("posts");
    postsDiv.innerHTML = "";

    for (const post of data.slice().reverse()) {
        const postDiv = document.createElement("div");
        postDiv.className = "post";

        postDiv.innerHTML = `
            <h3 id="post-title-${post.id}">${post.title}</h3>
            <p id="post-content-${post.id}">${post.content}</p>
            <small>By ${post.author} on ${new Date(post.created_at).toLocaleString()}</small>
            <button onclick="startEditPost(${post.id})">Edit Post</button>
            <button onclick="deletePost(${post.id})" style="background: red; color: white;">Delete Post</button>
            <div><strong>Comments:</strong></div>
            <div>
                <label>Add Comment:</label>
                <input type="text" id="comment-author-${post.id}" placeholder="Your name">
                <input type="text" id="comment-text-${post.id}" placeholder="Your comment">
                <button onclick="addComment(${post.id})">Post Comment</button>
            </div>
            <div id="comment-${post.id}">
                ${renderComments((post.comments || []).reverse(), post.id)}
            </div>
        `;
        postsDiv.appendChild(postDiv);
    }
}

function getCSRFToken() {
    const name = "csrftoken";
    const cookies = document.cookie.split(";");
    for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + "=")) {
            return decodeURIComponent(cookie.substring(name.length + 1));
        }
    }
    return null;
}

function startEditPost(postId) {
    const titleEl = document.getElementById(`post-title-${postId}`);
    const contentEl = document.getElementById(`post-content-${postId}`);

    const currentTitle = titleEl.textContent;
    const currentContent = contentEl.textContent;

    titleEl.innerHTML = `<input type="text" id="edit-title-${postId}" value="${currentTitle}">`;
    contentEl.innerHTML = `<textarea id="edit-content-${postId}">${currentContent}</textarea>
        <br><button onclick="saveEditedPost(${postId})">Save</button>
        <button onclick="fetchPosts()">Cancel</button>`;
}

async function saveEditedPost(postId) {
    const newTitle = document.getElementById(`edit-title-${postId}`).value;
    const newContent = document.getElementById(`edit-content-${postId}`).value;

    const res = await fetch(`${API_BASE}/posts/${postId}/`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json",
                    "X-CSRFToken": getCSRFToken()
        },
        body: JSON.stringify({ title: newTitle, content: newContent })
    });

    if (!res.ok) {
        alert("Failed to update post.");
        return;
    }

    fetchPosts();
}

const commentsShown = {};

// Render comments up to limit
function renderComments(comments, postId) {
    // Sort new to old
    comments = comments.slice().sort((a,b) => new Date(b.created_at) - new Date(a.created_at));

    // Initialize commentsShown for this post if not set
    if (!(postId in commentsShown)) {
        commentsShown[postId] = 3;
    }

    // Show only up to commentsShown[postId]
    const shownComments = comments.slice(0, commentsShown[postId]);

    let html = shownComments.map(c => `
        <p>
            <strong>${c.name}:</strong>
            <span id="comment-text-${c.id}">${c.text}</span>
            <button onclick="startEditComment(${c.id}, ${postId})">Edit</button>
            <button onclick="deleteComment(${c.id})">Delete</button>
        </p>
    `).join('');

    // If there are more comments to show, show Show More button
    if (commentsShown[postId] < comments.length) {
        html += `<button class="show-more" onclick="showMoreComments(${postId})" id="show-more-${postId}">Show More</button>`;
    }

    // If we are showing more than initial 3, show Hide button
    if (commentsShown[postId] > 3) {
        html += `<button class="show-more" onclick="hideComments(${postId})" id="hide-${postId}">Hide</button>`;
    }

    return html;
}

function startEditComment(commentId, postId) {
    const textEl = document.getElementById(`comment-text-${commentId}`);
    const currentText = textEl.textContent;

    // Hide Edit and Delete buttons in the same <p>
    const parentP = textEl.parentElement;
    const buttons = parentP.querySelectorAll("button");
    buttons.forEach(btn => btn.style.display = "none");
    
    textEl.innerHTML = `
        <input type="text" id="edit-input-${commentId}" value="${currentText}">
        <button onclick="saveEditedComment(${commentId}, ${postId})">Save</button>
        <button onclick="fetchPosts()">Cancel</button>
    `;
}

async function saveEditedComment(commentId, postId) {
    const newText = document.getElementById(`edit-input-${commentId}`).value;

    const res = await fetch(`${API_BASE}/comments/${commentId}/`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json",
                    "X-CSRFToken": getCSRFToken()
         },
        body: JSON.stringify({ text: newText })
    });

    if (!res.ok) {
        alert("Failed to update comment.");
        return;
    }

    fetchPosts();
}

function showMoreComments(postId) {
    // Increase number of comments shown by 5
    commentsShown[postId] = (commentsShown[postId] || 3) + 5;
    fetchPosts(); // Re-render posts with updated comment count
}

function hideComments(postId) {
    commentsShown[postId] = 3;
    fetchPosts();
}

// Add new comment
async function addComment(postId) {
    const author = document.getElementById(`comment-author-${postId}`).value;
    const text = document.getElementById(`comment-text-${postId}`).value;

    if (!author || !text) {
        alert("Please enter both your name and comment.");
        return;
    }
    console.log("Adding comment:", { post: postId, name: author, text });
    const res = await fetch(`${API_BASE}/comments/`, {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRFToken": getCSRFToken() },
        body: JSON.stringify({ post: postId, name: author, text })
    });

    if (!res.ok) {
        const err = await res.json();
        console.error("Failed to add comment:", err);
        alert("Error adding comment: " + JSON.stringify(err));
        return;
    }

    document.getElementById(`comment-author-${postId}`).value = "";
    document.getElementById(`comment-text-${postId}`).value = "";
    fetchPosts();
}

// Add new post
async function addPost() {
    const title = document.getElementById("title").value;
    const content = document.getElementById("content").value;
    const author = document.getElementById("author").value;

    await fetch(`${API_BASE}/posts/`, {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRFToken": getCSRFToken() },
        body: JSON.stringify({ title, content, author })
    });

    closeModal();
    fetchPosts();
}

async function deletePost(postId) {
    const confirmed = confirm("Are you sure you want to delete this post?");
    if (!confirmed) return;

    const res = await fetch(`${API_BASE}/posts/${postId}/`, {
        method: "DELETE"
    });

    if (!res.ok) {
        const err = await res.json();
        alert("Failed to delete post: " + JSON.stringify(err));
        return;
    }

    fetchPosts();
}

async function deleteComment(commentId) {
    const confirmed = confirm("Delete this comment?");
    if (!confirmed) return;

    const res = await fetch(`${API_BASE}/comments/${commentId}/`, {
        method: "DELETE"
    });

    if (!res.ok) {
        const err = await res.json();
        alert("Failed to delete comment: " + JSON.stringify(err));
        return;
    }

    fetchPosts();
}

// Generate AI post
async function generateAI() {
    const prompt = document.getElementById("prompt").value;

    await fetch(`${API_BASE}/generate_post/`, {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRFToken": getCSRFToken() },
        body: JSON.stringify({ prompt })
    });

    closeModal();
    fetchPosts();
}

// Load posts on page load
fetchPosts();
</script>
</body>
</html>